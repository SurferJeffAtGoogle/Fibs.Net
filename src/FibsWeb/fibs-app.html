<link rel="import" href="bower_components/polymer/polymer.html" />
<link rel="import" href="fibs-login.html" />
<link rel="import" href="fibs-motd.html" />

<dom-module id="fibs-app">
  <template>
    <fibs-login status="[[status]]"></fibs-login>
    <fibs-motd></fibs-motd>
  </template>
  <script>
    Polymer({
      is: "fibs-app",

      properties: {
        status: {
          type: String,
          notify: true,
          value: "closed",
        },
      },

      ready: function () {
        console.log("fibs-app ready");
      },

      send: function (s) {
        if (!this._socket) { throw "login first"; }
        this._socket.send(s);
      },

      login: function (user, password) {
        if (this._socket) { throw "logout first"; }

        this._socket = new WebSocket("ws://localhost:62953/fibs");
        this.status = "opening";

        this._socket.onopen = e => {
          console.log("socket: logging in as " + user);
          this.status = "logging in";
          this._socket.send("login " + user + " " + password);
        };

        this._socket.onmessage = e => {
          this.status = "logged in";
          //console.log("socket: message= " + e.data);
          JSON.parse(e.data).forEach(message => {
            this.fire(message.cookie, message.crumbs);
          });
        };

        this._socket.onclose = e => {
          console.log("socket: closed");
          this.status = "closed";
          this._socket = undefined;
          this.fire("FIBS_Closed");
        };

        this._socket.onerror = e => {
          console.log("socket: error= " + e.data);
        };
      },

      logout: function () {
        console.log("logout");
        this.status = "sending bye";
        if (this._socket) { this._socket.send("bye"); }
      },

    });
  </script>
</dom-module>
