<link rel="import" href="../bower_components/polymer/polymer.html">

<script>
  Polymer({
    is: "fibs-client",

    hostAttributes: {
      hidden: true
    },

    properties: {
      session: {
        type: Object,
        notify: true,
        value: function () { return { status: "closed" }; } // status = closed|opened|authenticated
      },

      settings: {
        type: Object,
        notify: true,
        value: function () { return {}; }
      },
    },

    ready: function () {
      let parseBool = s => s == "1" || s == "YES";
      let parseString = s => s;

      this._settingsParsers = {
        allowpip: parseBool,
        autoboard: parseBool,
        autodouble: parseBool,
        automove: parseBool,
        away: parseBool,
        bell: parseBool,
        crawford: parseBool,
        double: parseBool,
        experience: parseInt,
        greedy: parseBool,
        moreboards: parseBool,
        moves: parseBool,
        notify: parseBool,
        rating: parseFloat,
        ratings: parseBool,
        ready: parseBool,
        redoubles: parseString,
        report: parseBool,
        silent: parseBool,
        telnet: parseBool,
        timezone: parseString,
        wrap: parseBool,
      };
    },

    login: function (user, password) {
      if (this._socket) { throw "logout first"; }
      this._socket = new WebSocket("ws://localhost:62953/fibs"); // TODO

      this._socket.onopen = e => {
        console.log("socket: logging in as " + user);
        this.set("session.status", "opened");
        this._socket.send("login " + user + " " + password);
      };

      this._socket.onmessage = e => {
        //console.log("socket: message= " + e.data);
        JSON.parse(e.data).forEach(message => {
          this._processSession(message);
          this._processSettings(message);
          this._processWho(message);
        });
      };

      this._socket.onclose = e => {
        console.log("socket: closed");
        this._socket = undefined;
        this.session = { status: "closed" };
        this.settings = {};
      };

      this._socket.onerror = e => {
        console.log("socket: error");
        this.set("session.error", "error"); // TODO
      };
    },

    send: function (s) {
      if (!this._socket) { throw "login first"; }
      this._socket.send(s);
    },

    logout: function () {
      console.log("logout");
      if (this._socket) { this._socket.send("bye"); }
    },

    //#region session
    _processSession: function (message) {
      let parseTimestamp = s => new Date(parseInt(s) * 1000);

      switch (message.cookie) {
        case "CLIP_WELCOME":
          this.set("session.status", "authenticated");
          this.set("session.lastLogin", parseTimestamp(message.crumbs.lastLogin));
          this.set("session.lastHost", message.crumbs.lastHost);
          this.set("session.motd", []);
          break;

        case "FIBS_MOTD":
          // strip all of the ASCII box stuff from around the MOTD
          let line = message.crumbs.message.trim();
          if (line.startsWith("+")) { return; }
          if (line.startsWith("|")) { line = line.substr(1); }
          if (line.endsWith("|")) { line = line.substr(0, line.length - 1); }
          line = line.trim();
          if (line == "") { return; }
          this.push("session.motd", line);
      }
    },
    //#endregion

    //#region settings
    _processSettings: function (message) {
      switch (message.cookie) {
        case "CLIP_OWN_INFO":
          this._setCrumbSettings(message);
          break;

        case "FIBS_SettingsValue":
        case "FIBS_SettingsToggle":
          let m = { crumbs: {} };
          m.crumbs[message.crumbs.name] = message.crumbs.value;
          this._setCrumbSettings(m);
          break;
      }
    },

    _setCrumbSettings: function (message) {
      Object.keys(message.crumbs).filter(n => n != "name").forEach(name => {
        let parse = this._settingsParsers[name];
        let value = parse(message.crumbs[name]);

        // NOTE: this.set() is required for nested properties, e.g. obj.foo
        this.set(`settings.${name}`, value);
      });
    },
    //#endregion

    //#region who
    _processWho: function (message) {
    },
    //#endregion

  });
</script>
